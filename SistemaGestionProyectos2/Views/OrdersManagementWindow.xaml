<Window x:Class="SistemaGestionProyectos2.Views.OrdersManagementWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:SistemaGestionProyectos2.Services"
        Title="IMA Mecatrónica - Manejo de Órdenes" 
        Height="800" 
        Width="1400"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        WindowStyle="None"
        ResizeMode="NoResize"
        x:Name="OrdersWindow">

    <Window.Resources>
        <local:AdminVisibilityConverter x:Key="AdminVisibilityConverter"/>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="30"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="Black" Height="60">
            <Grid>
                <StackPanel Orientation="Horizontal" 
                           VerticalAlignment="Center"
                           Margin="20,0">
                    <!-- Logo IMA -->
                    <Border Width="100" Height="35" Margin="0,0,20,0">
                        <Grid>
                            <Rectangle Stroke="White" StrokeThickness="1.5"/>
                            <TextBlock Text="IMA" 
                                     FontSize="18" 
                                     FontWeight="Bold"
                                     Foreground="White"
                                     HorizontalAlignment="Center"
                                     VerticalAlignment="Center"/>
                        </Grid>
                    </Border>

                    <TextBlock Text="MANEJO DE ÓRDENES" 
                             Foreground="White"
                             FontSize="22"
                             FontWeight="Bold"
                             VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Botones de navegación -->
                <StackPanel Orientation="Horizontal" 
                           HorizontalAlignment="Right"
                           VerticalAlignment="Center"
                           Margin="0,0,20,0">
                    <Button Content="⬅ Volver" 
                           Click="BackButton_Click"
                           Background="Transparent"
                           BorderBrush="White"
                           BorderThickness="1"
                           Foreground="White"
                           Padding="15,5"
                           Margin="0,0,10,0"
                           Cursor="Hand"/>

                    <Button x:Name="ExportButton"
                           Content="📊 Exportar" 
                           Background="Transparent"
                           BorderBrush="White"
                           BorderThickness="1"
                           Foreground="White"
                           Padding="15,5"
                           Margin="0,0,10,0"
                           Cursor="Hand"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Toolbar -->
        <Border Grid.Row="1" Background="#f5f5f5" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Botones de acción -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button x:Name="NewOrderButton"
                           Click="NewOrderButton_Click"
                           Height="40"
                           Width="150"
                           Margin="0,0,10,0"
                           Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="border"
                                       Background="#FFC107"
                                       CornerRadius="3">
                                    <ContentPresenter HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="border" Property="Background" Value="#FFB300"/>
                                    </Trigger>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter TargetName="border" Property="Background" Value="#DDD"/>
                                        <Setter TargetName="border" Property="Opacity" Value="0.6"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="➕" FontSize="16" Margin="0,0,8,0" Foreground="Black"/>
                            <TextBlock Text="NUEVA ORDEN" FontWeight="Bold" Foreground="Black"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="RefreshButton"
                           Click="RefreshButton_Click"
                           Content="🔄"
                           Width="40"
                           Height="40"
                           FontSize="18"
                           Background="White"
                           BorderBrush="#999"
                           BorderThickness="1"
                           Margin="0,0,10,0"
                           Cursor="Hand"
                           ToolTip="Actualizar"/>
                </StackPanel>

                <!-- Búsqueda -->
                <Border Grid.Column="1" 
                       BorderBrush="#999"
                       BorderThickness="1"
                       Background="White"
                       CornerRadius="3"
                       Height="35"
                       HorizontalAlignment="Right"
                       Width="300"
                       Margin="10,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="SearchBox"
                                BorderThickness="0"
                                VerticalAlignment="Center"
                                Margin="10,0"
                                FontSize="14"
                                TextChanged="SearchBox_TextChanged">
                            <TextBox.Style>
                                <Style TargetType="TextBox">
                                    <Style.Triggers>
                                        <Trigger Property="Text" Value="">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <VisualBrush AlignmentX="Left" AlignmentY="Center" Stretch="None">
                                                        <VisualBrush.Visual>
                                                            <TextBlock Text="Buscar por O.C., Cliente o Descripción..." 
                                                                     Foreground="#999" 
                                                                     FontStyle="Italic"/>
                                                        </VisualBrush.Visual>
                                                    </VisualBrush>
                                                </Setter.Value>
                                            </Setter>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBox.Style>
                        </TextBox>

                        <TextBlock Grid.Column="1" 
                                 Text="🔍"
                                 FontSize="16"
                                 VerticalAlignment="Center"
                                 Margin="0,0,10,0"
                                 Foreground="#666"/>
                    </Grid>
                </Border>

                <!-- Filtros -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <TextBlock Text="Estado:" 
                             VerticalAlignment="Center"
                             Margin="0,0,5,0"/>
                    <ComboBox x:Name="StatusFilter"
                            Width="150"
                            Height="35"
                            SelectionChanged="StatusFilter_SelectionChanged">
                        <ComboBoxItem Content="Todos" IsSelected="True"/>
                        <ComboBoxItem Content="CREADA"/>
                        <ComboBoxItem Content="EN PROCESO"/>
                        <ComboBoxItem Content="LIBERADA"/>
                        <ComboBoxItem Content="CERRADA"/>
                        <ComboBoxItem Content="COMPLETADA"/>
                        <ComboBoxItem Content="CANCELADA"/>
                    </ComboBox>
                </StackPanel>
            </Grid>
        </Border>

        <!-- DataGrid -->
        <Border Grid.Row="2" Margin="10" BorderBrush="#DDD" BorderThickness="1">
            <DataGrid x:Name="OrdersDataGrid"
                     AutoGenerateColumns="False"
                     CanUserAddRows="False"
                     CanUserDeleteRows="False"
                     IsReadOnly="True"  
                     SelectionMode="Extended"
                     SelectionUnit="Cell"
                     GridLinesVisibility="Horizontal"
                     HeadersVisibility="Column"
                     Background="White"
                     BorderThickness="0"
                     RowHeight="35"
                     FontSize="12">

                <DataGrid.Resources>
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="Background" Value="#f0f0f0"/>
                        <Setter Property="Foreground" Value="Black"/>
                        <Setter Property="FontWeight" Value="Bold"/>
                        <Setter Property="Height" Value="40"/>
                        <Setter Property="BorderBrush" Value="#DDD"/>
                        <Setter Property="BorderThickness" Value="0,0,1,1"/>
                        <Setter Property="Padding" Value="10,0"/>
                    </Style>

                    <Style TargetType="DataGridRow">
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E3F2FD"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="#BBDEFB"/>
                                <Setter Property="Foreground" Value="Black"/>
                                
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                    <Style TargetType="DataGridCell">
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="#90CAF9"/>
                                <Setter Property="Foreground" Value="Black"/>
                                <Setter Property="BorderBrush" Value="#1976D2"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.Resources>

                <DataGrid.Columns>
                    <!-- Columnas visibles para todos -->
                    <DataGridTextColumn Header="O.C." 
                                       Binding="{Binding OrderNumber}" 
                                       Width="100"/>

                    <DataGridTextColumn Header="FECHA O.C." 
                                       Binding="{Binding OrderDate, StringFormat=dd/MM/yyyy}" 
                                       Width="100"/>

                    <DataGridTextColumn Header="EMPRESA" 
                                       Binding="{Binding ClientName}" 
                                       Width="200"/>

                    <DataGridTextColumn Header="DESCRIPCIÓN" 
                                       Binding="{Binding Description}" 
                                       Width="*"/>

                    <DataGridTextColumn Header="VENDEDOR" 
                                       Binding="{Binding VendorName}" 
                                       Width="150"/>

                    <DataGridTextColumn Header="FECHA PROMESA" 
                                       Binding="{Binding PromiseDate, StringFormat=dd/MM/yyyy}" 
                                       Width="110"/>

                    <DataGridTextColumn Header="% AVANCE" 
                                       Binding="{Binding ProgressPercentage, StringFormat={}{0}%}" 
                                       Width="80">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Center"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Columnas exclusivas para Admin -->
                    <DataGridTextColumn x:Name="SubtotalColumn"
                                       Header="SUBTOTAL" 
                                       Binding="{Binding Subtotal, StringFormat=C}" 
                                       Width="100"
                                       Visibility="Collapsed">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridTextColumn x:Name="TotalColumn"
                                       Header="TOTAL" 
                                       Binding="{Binding Total, StringFormat=C}" 
                                       Width="100"
                                       Visibility="Collapsed">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    
                    <DataGridTextColumn x:Name="InvoicedColumn"
                   Header="FACTURADO" 
                   Binding="{Binding InvoicedAmount, StringFormat=C}" 
                   Width="110">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                                <Style.Triggers>
                                    <!-- Verde si está completo -->
                                    <DataTrigger Binding="{Binding Path=InvoicedPercentage}" Value="100">
                                        <Setter Property="Foreground" Value="#4CAF50"/>
                                    </DataTrigger>
                                    <!-- Amarillo si está parcial -->
                                    <DataTrigger Binding="{Binding Path=InvoicedPercentage}">
                                        <DataTrigger.Value>
                                            <sys:Double xmlns:sys="clr-namespace:System;assembly=mscorlib">50</sys:Double>
                                        </DataTrigger.Value>
                                        <Setter Property="Foreground" Value="#FF9800"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>



                    <!-- Estado con colores -->
                    <!-- En el DataGridTemplateColumn del ESTATUS -->
                    <!-- Columna Estado con estilo de badges -->
                    <DataGridTemplateColumn x:Name="StatusColumn"
                        Header="ESTADO" 
                        Width="130">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border x:Name="StatusBorder" 
                    CornerRadius="3" 
                    Padding="8,4"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Status}" 
                          FontWeight="SemiBold"
                          FontSize="11"
                          HorizontalAlignment="Center"/>
                                </Border>
                                <DataTemplate.Triggers>
                                    <!-- CREADA - Gris -->
                                    <DataTrigger Binding="{Binding Status}" Value="CREADA">
                                        <Setter TargetName="StatusBorder" Property="Background" Value="#E0E0E0"/>
                                        <Setter TargetName="StatusBorder" Property="TextBlock.Foreground" Value="#616161"/>
                                    </DataTrigger>

                                    <!-- EN PROCESO - Naranja -->
                                    <DataTrigger Binding="{Binding Status}" Value="EN PROCESO">
                                        <Setter TargetName="StatusBorder" Property="Background" Value="#FFE0B2"/>
                                        <Setter TargetName="StatusBorder" Property="TextBlock.Foreground" Value="#E65100"/>
                                    </DataTrigger>

                                    <!-- LIBERADA - Amarillo Tráfico -->
                                    <DataTrigger Binding="{Binding Status}" Value="LIBERADA">
                                        <Setter TargetName="StatusBorder" Property="Background" Value="#FFD600"/>
                                        <Setter TargetName="StatusBorder" Property="TextBlock.Foreground" Value="#000000"/>
                                    </DataTrigger>

                                    <!-- CERRADA - Azul -->
                                    <DataTrigger Binding="{Binding Status}" Value="CERRADA">
                                        <Setter TargetName="StatusBorder" Property="Background" Value="#2196F3"/>
                                        <Setter TargetName="StatusBorder" Property="TextBlock.Foreground" Value="#FFFFFF"/>
                                    </DataTrigger>

                                    <!-- COMPLETADA - Verde -->
                                    <DataTrigger Binding="{Binding Status}" Value="COMPLETADA">
                                        <Setter TargetName="StatusBorder" Property="Background" Value="#C8E6C9"/>
                                        <Setter TargetName="StatusBorder" Property="TextBlock.Foreground" Value="#1B5E20"/>
                                    </DataTrigger>

                                    <!-- CANCELADA - Rojo -->
                                    <DataTrigger Binding="{Binding Status}" Value="CANCELADA">
                                        <Setter TargetName="StatusBorder" Property="Background" Value="#FFCDD2"/>
                                        <Setter TargetName="StatusBorder" Property="TextBlock.Foreground" Value="#B71C1C"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Header="ACCIONES" Width="150">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <!-- Botón Editar - Siempre visible -->
                                    <Button    Content="✏" 
                                               Click="EditButton_Click"
                                               Tag="{Binding}"
                                               Background="Transparent"
                                               BorderThickness="0"
                                               FontSize="16"
                                               Cursor="Hand"
                                               ToolTip="Editar"
                                               Margin="5,0"/>

                                    <!-- Botón Facturas - Solo visible para Admin usando Tag del Window -->
                                    <Button x:Name="InvoiceBtn"
                                               Content="💰" 
                                               Click="InvoiceButton_Click"
                                               Tag="{Binding}"
                                               Background="Transparent"
                                               BorderThickness="0"
                                               FontSize="16"
                                               Cursor="Hand"
                                               ToolTip="Gestionar Facturas"
                                               Margin="5,0"
                                               Visibility="{Binding ElementName=OrdersWindow, 
                                                           Path=Tag, 
                                                           Converter={StaticResource AdminVisibilityConverter}}"/>

                                    
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3" Background="#f0f0f0">
            <StatusBarItem>
                <TextBlock x:Name="StatusText" Text="0 órdenes cargadas"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <TextBlock x:Name="UserStatusText" Text="Usuario: "/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>