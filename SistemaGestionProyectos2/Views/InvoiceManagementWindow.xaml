<Window x:Class="SistemaGestionProyectos2.Views.InvoiceManagementWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Gestión de Facturas - IMA Mecatrónica" 
        Height="750" 
        Width="1100"
        WindowStartupLocation="CenterOwner"
        MinHeight="600"
        MinWidth="900">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Negro -->
        <Border Grid.Row="0" Background="Black" Height="60">
            <Grid>
                <StackPanel Orientation="Horizontal" 
                           VerticalAlignment="Center"
                           Margin="20,0">
                    <TextBlock Text="💰" 
                             Foreground="#FFC107"
                             FontSize="24"
                             Margin="0,0,15,0"/>
                    <TextBlock Text="GESTIÓN DE FACTURAS" 
                             Foreground="White"
                             FontSize="20"
                             FontWeight="Bold"
                             VerticalAlignment="Center"/>
                </StackPanel>

                <Button HorizontalAlignment="Right"
                       VerticalAlignment="Center"
                       Margin="0,0,20,0"
                       Content="✕"
                       Width="30"
                       Height="30"
                       Background="Transparent"
                       BorderThickness="0"
                       Foreground="White"
                       FontSize="16"
                       Cursor="Hand"
                       Click="CloseButton_Click"/>
            </Grid>
        </Border>

        <!-- Información de la Orden -->
        <Border Grid.Row="1" 
                Background="#1976D2"
                Padding="20,15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Primera línea: Info básica -->
                <StackPanel Grid.Row="0" Orientation="Horizontal">
                    <TextBlock Text="ORDEN: " 
                             Foreground="White"
                             FontSize="16"
                             FontWeight="Bold"/>
                    <TextBlock x:Name="OrderNumberText"
                             Text="HJ_0001"
                             Foreground="#FFC107"
                             FontSize="16"
                             FontWeight="Bold"
                             Margin="0,0,30,0"/>

                    <TextBlock Text="CLIENTE: "
                             Foreground="White"
                             FontSize="16"/>
                    <TextBlock x:Name="ClientNameText"
                             Text="Android"
                             Foreground="White"
                             FontSize="16"
                             FontWeight="Bold"
                             Margin="0,0,30,0"/>

                    <TextBlock Text="MONTO TOTAL: "
                             Foreground="White"
                             FontSize="16"/>
                    <TextBlock x:Name="OrderTotalText"
                             Text="$58,000.00"
                             Foreground="#4CAF50"
                             FontSize="16"
                             FontWeight="Bold"/>
                </StackPanel>

                <!-- Segunda línea: Balance y progreso -->
                <Grid Grid.Row="1" Margin="0,10,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <TextBlock Text="FACTURADO: "
                                 Foreground="White"
                                 FontSize="14"/>
                        <TextBlock x:Name="InvoicedAmountText"
                                 Text="$15,000.00"
                                 Foreground="#FFC107"
                                 FontSize="14"
                                 FontWeight="Bold"
                                 Margin="0,0,20,0"/>

                        <TextBlock Text="BALANCE: "
                                 Foreground="White"
                                 FontSize="14"/>
                        <TextBlock x:Name="BalanceText"
                                 Text="$43,000.00"
                                 Foreground="#FFE082"
                                 FontSize="14"
                                 FontWeight="Bold"/>
                    </StackPanel>

                    <!-- Barra de Progreso Visual -->
                    <Grid Grid.Column="1" Margin="20,0">
                        <ProgressBar x:Name="InvoiceProgressBar"
                                    Height="20"
                                    Maximum="100"
                                    Value="0"
                                    Background="#0D47A1"
                                    Foreground="#4CAF50"/>
                        <TextBlock x:Name="ProgressPercentText"
                                 Text="26%"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"
                                 Foreground="White"
                                 FontWeight="Bold"
                                 FontSize="12"/>
                    </Grid>

                    <TextBlock Grid.Column="2"
                             x:Name="WarningText"
                             Text="⚠️ Solo puede facturar $0,000.00 más"
                             Foreground="#FFE082"
                             FontSize="12"
                             VerticalAlignment="Center"/>
                </Grid>
            </Grid>
        </Border>

        <!-- Toolbar de Acciones -->
        <Border Grid.Row="2" 
                Background="#f5f5f5"
                Padding="10">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <Button x:Name="AddInvoiceButton"
                           Click="AddInvoiceButton_Click"
                           Height="35"
                           Width="140"
                           Margin="0,0,10,0"
                           Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="border"
                                       Background="#4CAF50"
                                       CornerRadius="3">
                                    <ContentPresenter HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="border" Property="Background" Value="#45A049"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="➕" FontSize="14" Margin="0,0,8,0" Foreground="White"/>
                            <TextBlock Text="Nueva Factura" FontWeight="Bold" Foreground="White"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="SaveAllButton"
                           Click="SaveAllButton_Click"
                           Content="💾 Guardar Todo"
                           Height="35"
                           Width="130"
                           Background="#2196F3"
                           Foreground="White"
                           FontWeight="Bold"
                           BorderThickness="0"
                           Margin="0,0,10,0"
                           Cursor="Hand"/>

                    <Button x:Name="RefreshButton"
                           Click="RefreshButton_Click"
                           Content="🔄"
                           Width="35"
                           Height="35"
                           FontSize="16"
                           Background="White"
                           BorderBrush="#999"
                           BorderThickness="1"
                           Cursor="Hand"
                           ToolTip="Actualizar"/>
                </StackPanel>

                <TextBlock HorizontalAlignment="Right"
                         VerticalAlignment="Center"
                         x:Name="StatusMessage"
                         Text=""
                         FontStyle="Italic"
                         Foreground="#666"/>
            </Grid>
        </Border>

        <!-- DataGrid de Facturas -->
        <Border Grid.Row="3" 
                Margin="10" 
                BorderBrush="#DDD" 
                BorderThickness="1">
            <DataGrid x:Name="InvoicesDataGrid"
                     AutoGenerateColumns="False"
                     CanUserAddRows="False"
                     CanUserDeleteRows="False"
                     SelectionMode="Single"
                     GridLinesVisibility="Horizontal"
                     HeadersVisibility="Column"
                     Background="White"
                     BorderThickness="0"
                     RowHeight="40"
                     FontSize="13"
                     CellEditEnding="InvoicesDataGrid_CellEditEnding"
                     PreparingCellForEdit="InvoicesDataGrid_PreparingCellForEdit">

                <DataGrid.Resources>
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="Background" Value="#263238"/>
                        <Setter Property="Foreground" Value="White"/>
                        <Setter Property="FontWeight" Value="Bold"/>
                        <Setter Property="Height" Value="40"/>
                        <Setter Property="BorderBrush" Value="#37474F"/>
                        <Setter Property="BorderThickness" Value="0,0,1,0"/>
                        <Setter Property="Padding" Value="10,0"/>
                    </Style>

                    <Style TargetType="DataGridRow">
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E3F2FD"/>
                            </Trigger>
                            <DataTrigger Binding="{Binding IsNew}" Value="True">
                                <Setter Property="Background" Value="#F0F4C3"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding HasChanges}" Value="True">
                                <Setter Property="FontStyle" Value="Italic"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.Resources>

                <DataGrid.Columns>
                    <!-- Número -->
                    <DataGridTextColumn Header="No." 
                                       Binding="{Binding Id}" 
                                       Width="50"
                                       IsReadOnly="True">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Center"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Folio -->
                    <DataGridTextColumn Header="FOLIO FACTURA" 
                                       Binding="{Binding Folio}" 
                                       Width="150">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="Padding" Value="5,0"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Fecha Factura -->
                    <DataGridTemplateColumn Header="FECHA FACTURA" Width="130">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding InvoiceDate, StringFormat=dd/MM/yyyy}"
                                         VerticalAlignment="Center"
                                         Padding="5,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <DatePicker SelectedDate="{Binding InvoiceDate}"
                                          VerticalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <!-- Subtotal -->
                    <DataGridTextColumn Header="SUBTOTAL" 
                                       Binding="{Binding Subtotal, StringFormat=C}" 
                                       Width="120">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Padding" Value="0,0,10,0"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Total (Calculado) -->
                    <DataGridTextColumn Header="TOTAL (c/IVA)" 
                                       Binding="{Binding Total, StringFormat=C}" 
                                       Width="120"
                                       IsReadOnly="True">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Padding" Value="0,0,10,0"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                                <Setter Property="Foreground" Value="#2E7D32"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Fecha Recepción -->
                    <DataGridTemplateColumn Header="RECIBO FACT." Width="130">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ReceptionDate, StringFormat=dd/MM/yyyy}"
                                         VerticalAlignment="Center"
                                         Padding="5,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <DatePicker SelectedDate="{Binding ReceptionDate}"
                                          VerticalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <!-- Pago Programado (Calculado) -->
                    <DataGridTextColumn Header="PAGO PROG." 
                                       Binding="{Binding DueDate, StringFormat=dd/MM/yyyy}" 
                                       Width="110"
                                       IsReadOnly="True">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Center"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="FontStyle" Value="Italic"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Fecha Pago Real -->
                    <DataGridTemplateColumn Header="FECHA PAGO" Width="130">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding PaymentDate, StringFormat=dd/MM/yyyy}"
                                         VerticalAlignment="Center"
                                         Padding="5,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <DatePicker SelectedDate="{Binding PaymentDate}"
                                          VerticalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <!-- Estado con colores -->
                    <DataGridTemplateColumn Header="ESTADO" Width="120">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border CornerRadius="10" 
                                       Padding="10,4"
                                       HorizontalAlignment="Center"
                                       Background="{Binding StatusColor}">
                                    <TextBlock Text="{Binding Status}" 
                                             FontWeight="Bold"
                                             FontSize="11"
                                             Foreground="White"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Acciones -->
                    <DataGridTemplateColumn Header="ACCIONES" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="🗑️" 
                                       Click="DeleteButton_Click"
                                       Tag="{Binding}"
                                       Background="Transparent"
                                       BorderThickness="0"
                                       FontSize="16"
                                       Cursor="Hand"
                                       ToolTip="Eliminar factura"
                                       HorizontalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <!-- Footer con resumen -->
        <Border Grid.Row="4" 
                Background="#263238"
                Padding="15,10">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Total Facturas: "
                             Foreground="White"
                             FontSize="12"/>
                    <TextBlock x:Name="InvoiceCountText"
                             Text="0"
                             Foreground="#FFC107"
                             FontWeight="Bold"
                             FontSize="12"
                             Margin="0,0,20,0"/>

                    <TextBlock Text="Suma Subtotales: "
                             Foreground="White"
                             FontSize="12"/>
                    <TextBlock x:Name="SubtotalSumText"
                             Text="$0.00"
                             Foreground="#4CAF50"
                             FontWeight="Bold"
                             FontSize="12"
                             Margin="0,0,20,0"/>

                    <TextBlock Text="Suma Totales: "
                             Foreground="White"
                             FontSize="12"/>
                    <TextBlock x:Name="TotalSumText"
                             Text="$0.00"
                             Foreground="#4CAF50"
                             FontWeight="Bold"
                             FontSize="12"/>
                </StackPanel>

                <TextBlock HorizontalAlignment="Right"
                         x:Name="LastUpdateText"
                         Text="Última actualización: --"
                         Foreground="#B0BEC5"
                         FontSize="10"/>
            </Grid>
        </Border>
    </Grid>
</Window>