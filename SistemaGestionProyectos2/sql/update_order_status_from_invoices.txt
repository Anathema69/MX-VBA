[
  {
    "routine_name": "update_order_status_from_invoices",
    "routine_definition": "\r\nDECLARE\r\n    v_order_total DECIMAL;\r\n    v_invoiced_total DECIMAL;\r\n    v_percentage DECIMAL;\r\n    v_current_status INTEGER;\r\n    v_invoice_count INTEGER;\r\n    v_created_count INTEGER;\r\n    v_pending_count INTEGER;\r\n    v_paid_count INTEGER;\r\n    v_new_status INTEGER;\r\n    v_should_update BOOLEAN := FALSE;\r\n    v_has_reception_all BOOLEAN;\r\nBEGIN\r\n    -- Obtener el estado actual y total de la orden\r\n    SELECT f_orderstat, f_saletotal \r\n    INTO v_current_status, v_order_total\r\n    FROM t_order \r\n    WHERE f_order = COALESCE(NEW.f_order, OLD.f_order);\r\n    \r\n    -- No procesar si la orden está cancelada (5)\r\n    IF v_current_status = 5 THEN\r\n        RETURN NEW;\r\n    END IF;\r\n    \r\n    -- Calcular totales y contar estados de facturas\r\n    SELECT \r\n        COUNT(*),\r\n        COALESCE(SUM(f_total), 0),\r\n        COUNT(CASE WHEN f_invoicestat = 1 THEN 1 END), -- CREADA\r\n        COUNT(CASE WHEN f_invoicestat = 2 THEN 1 END), -- PENDIENTE  \r\n        COUNT(CASE WHEN f_invoicestat = 4 THEN 1 END), -- PAGADA\r\n        -- Verificar si TODAS las facturas tienen fecha de recepción\r\n        (COUNT(*) = COUNT(CASE WHEN f_receptiondate IS NOT NULL THEN 1 END))\r\n    INTO \r\n        v_invoice_count,\r\n        v_invoiced_total,\r\n        v_created_count,\r\n        v_pending_count,\r\n        v_paid_count,\r\n        v_has_reception_all\r\n    FROM t_invoice \r\n    WHERE f_order = COALESCE(NEW.f_order, OLD.f_order);\r\n    \r\n    -- Calcular porcentaje facturado\r\n    IF v_order_total > 0 THEN\r\n        v_percentage := (v_invoiced_total / v_order_total * 100);\r\n    ELSE\r\n        v_percentage := 0;\r\n    END IF;\r\n    \r\n    -- Determinar el nuevo estado según las reglas de negocio\r\n    -- IMPORTANTE: Evaluar de mayor a menor jerarquía\r\n    v_new_status := v_current_status; -- Por defecto mantener el actual\r\n    \r\n    -- Evaluar todas las condiciones posibles sin importar el estado actual\r\n    -- para determinar cuál DEBERÍA ser el estado correcto\r\n    \r\n    IF v_invoice_count > 0 THEN\r\n        -- Primero verificar si TODAS están pagadas (estado más alto)\r\n        IF v_paid_count = v_invoice_count AND v_percentage >= 99 THEN\r\n            v_new_status := 4; -- COMPLETADA\r\n            v_should_update := TRUE;\r\n            \r\n        -- Luego verificar si todas tienen recepción (pendientes o pagadas) Y 100% facturado\r\n        ELSIF v_has_reception_all AND (v_pending_count + v_paid_count) = v_invoice_count AND v_percentage >= 99 THEN\r\n            v_new_status := 3; -- CERRADA\r\n            v_should_update := TRUE;\r\n            \r\n        -- Finalmente verificar si hay 100% facturado\r\n        ELSIF v_percentage >= 99 THEN\r\n            v_new_status := 2; -- LIBERADA\r\n            v_should_update := TRUE;\r\n            \r\n        -- Si hay facturas pero no se cumple ninguna condición anterior\r\n        ELSIF v_current_status = 0 THEN\r\n            v_new_status := 1; -- EN PROCESO\r\n            v_should_update := TRUE;\r\n        END IF;\r\n    END IF;\r\n    \r\n    -- Solo actualizar si el nuevo estado es diferente al actual y es válido avanzar\r\n    -- (no retroceder en la jerarquía de estados)\r\n    IF v_should_update AND v_new_status != v_current_status AND v_new_status > v_current_status THEN\r\n        UPDATE t_order \r\n        SET \r\n            f_orderstat = v_new_status,\r\n            order_percentage = ROUND(v_percentage),\r\n            invoiced = CASE WHEN v_invoiced_total > 0 THEN TRUE ELSE FALSE END,\r\n            last_invoice_date = CASE WHEN v_invoiced_total > 0 THEN CURRENT_DATE ELSE last_invoice_date END,\r\n            updated_at = NOW()\r\n        WHERE f_order = COALESCE(NEW.f_order, OLD.f_order);\r\n        \r\n        -- Registrar en historial\r\n        INSERT INTO order_history (\r\n            order_id, \r\n            user_id, \r\n            action, \r\n            field_name,\r\n            old_value, \r\n            new_value, \r\n            change_description, \r\n            changed_at\r\n        ) VALUES (\r\n            COALESCE(NEW.f_order, OLD.f_order),\r\n            COALESCE(NEW.created_by, 1),\r\n            'AUTO_STATUS_UPDATE',\r\n            'f_orderstat',\r\n            v_current_status::TEXT,\r\n            v_new_status::TEXT,\r\n            CASE v_new_status\r\n                WHEN 2 THEN 'Orden liberada - Facturación al 100%'\r\n                WHEN 3 THEN 'Orden cerrada - Todas las facturas con fecha de recepción'\r\n                WHEN 4 THEN 'Orden completada - Todas las facturas pagadas'\r\n                ELSE 'Actualización automática por cambio en facturas'\r\n            END,\r\n            NOW()\r\n        );\r\n        \r\n        -- Si cambió a CERRADA (3), verificar si necesita crear comisión\r\n        IF v_new_status = 3 THEN\r\n            PERFORM create_vendor_commission_if_needed(COALESCE(NEW.f_order, OLD.f_order));\r\n        END IF;\r\n    ELSE\r\n        -- Solo actualizar el porcentaje sin cambiar estado\r\n        UPDATE t_order \r\n        SET \r\n            order_percentage = ROUND(v_percentage),\r\n            invoiced = CASE WHEN v_invoiced_total > 0 THEN TRUE ELSE FALSE END,\r\n            last_invoice_date = CASE WHEN v_invoiced_total > 0 THEN CURRENT_DATE ELSE last_invoice_date END,\r\n            updated_at = NOW()\r\n        WHERE f_order = COALESCE(NEW.f_order, OLD.f_order);\r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEND;\r\n"
  }
]