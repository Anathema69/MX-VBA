CREATE OR REPLACE FUNCTION public.update_order_status_from_invoices()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_order_total DECIMAL;
    v_invoiced_total DECIMAL;
    v_percentage DECIMAL;
    v_current_status INTEGER;
    v_invoice_count INTEGER;
    v_created_count INTEGER;
    v_pending_count INTEGER;
    v_paid_count INTEGER;
    v_new_status INTEGER;
    v_should_update BOOLEAN := FALSE;
    v_has_reception_all BOOLEAN;
BEGIN
    -- Obtener el estado actual y total de la orden
    SELECT f_orderstat, f_saletotal 
    INTO v_current_status, v_order_total
    FROM t_order 
    WHERE f_order = COALESCE(NEW.f_order, OLD.f_order);
    
    -- No procesar si la orden está cancelada (5)
    IF v_current_status = 5 THEN
        RETURN NEW;
    END IF;
    
    -- Calcular totales y contar estados de facturas
    SELECT 
        COUNT(*),
        COALESCE(SUM(f_total), 0),
        COUNT(CASE WHEN f_invoicestat = 1 THEN 1 END), -- CREADA
        COUNT(CASE WHEN f_invoicestat = 2 THEN 1 END), -- PENDIENTE  
        COUNT(CASE WHEN f_invoicestat = 4 THEN 1 END), -- PAGADA
        -- Verificar si TODAS las facturas tienen fecha de recepción
        (COUNT(*) = COUNT(CASE WHEN f_receptiondate IS NOT NULL THEN 1 END))
    INTO 
        v_invoice_count,
        v_invoiced_total,
        v_created_count,
        v_pending_count,
        v_paid_count,
        v_has_reception_all
    FROM t_invoice 
    WHERE f_order = COALESCE(NEW.f_order, OLD.f_order);
    
    -- Calcular porcentaje facturado
    IF v_order_total > 0 THEN
        v_percentage := (v_invoiced_total / v_order_total * 100);
    ELSE
        v_percentage := 0;
    END IF;
    
    -- Determinar el nuevo estado según las reglas de negocio
    -- IMPORTANTE: Evaluar de mayor a menor jerarquía
    v_new_status := v_current_status; -- Por defecto mantener el actual
    
    -- Evaluar todas las condiciones posibles sin importar el estado actual
    -- para determinar cuál DEBERÍA ser el estado correcto
    
    IF v_invoice_count > 0 THEN
        -- Primero verificar si TODAS están pagadas (estado más alto)
        IF v_paid_count = v_invoice_count AND v_percentage >= 99 THEN
            v_new_status := 4; -- COMPLETADA
            v_should_update := TRUE;
            
        -- Luego verificar si todas tienen recepción (pendientes o pagadas) Y 100% facturado
        ELSIF v_has_reception_all AND (v_pending_count + v_paid_count) = v_invoice_count AND v_percentage >= 99 THEN
            v_new_status := 3; -- CERRADA
            v_should_update := TRUE;
            
        -- Finalmente verificar si hay 100% facturado
        ELSIF v_percentage >= 99 THEN
            v_new_status := 2; -- LIBERADA
            v_should_update := TRUE;
            
        -- Si hay facturas pero no se cumple ninguna condición anterior
        ELSIF v_current_status = 0 THEN
            v_new_status := 1; -- EN PROCESO
            v_should_update := TRUE;
        END IF;
    END IF;
    
    -- Solo actualizar si el nuevo estado es diferente al actual y es válido avanzar
    -- (no retroceder en la jerarquía de estados)
    IF v_should_update AND v_new_status != v_current_status AND v_new_status > v_current_status THEN
        UPDATE t_order 
        SET 
            f_orderstat = v_new_status,
            order_percentage = ROUND(v_percentage),
            invoiced = CASE WHEN v_invoiced_total > 0 THEN TRUE ELSE FALSE END,
            last_invoice_date = CASE WHEN v_invoiced_total > 0 THEN CURRENT_DATE ELSE last_invoice_date END,
            updated_at = NOW()
        WHERE f_order = COALESCE(NEW.f_order, OLD.f_order);
        
        -- Registrar en historial
        INSERT INTO order_history (
            order_id, 
            user_id, 
            action, 
            field_name,
            old_value, 
            new_value, 
            change_description, 
            changed_at
        ) VALUES (
            COALESCE(NEW.f_order, OLD.f_order),
            COALESCE(NEW.created_by, 1),
            'AUTO_STATUS_UPDATE',
            'f_orderstat',
            v_current_status::TEXT,
            v_new_status::TEXT,
            CASE v_new_status
                WHEN 2 THEN 'Orden liberada - Facturación al 100%'
                WHEN 3 THEN 'Orden cerrada - Todas las facturas con fecha de recepción'
                WHEN 4 THEN 'Orden completada - Todas las facturas pagadas'
                ELSE 'Actualización automática por cambio en facturas'
            END,
            NOW()
        );
        
        -- Si cambió a CERRADA (3), verificar si necesita crear comisión
        IF v_new_status = 3 THEN
            PERFORM create_vendor_commission_if_needed(COALESCE(NEW.f_order, OLD.f_order));
        END IF;
    ELSE
        -- Solo actualizar el porcentaje sin cambiar estado
        UPDATE t_order 
        SET 
            order_percentage = ROUND(v_percentage),
            invoiced = CASE WHEN v_invoiced_total > 0 THEN TRUE ELSE FALSE END,
            last_invoice_date = CASE WHEN v_invoiced_total > 0 THEN CURRENT_DATE ELSE last_invoice_date END,
            updated_at = NOW()
        WHERE f_order = COALESCE(NEW.f_order, OLD.f_order);
    END IF;
    
    RETURN NEW;
END;
$function$
